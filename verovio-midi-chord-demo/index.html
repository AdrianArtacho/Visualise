<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Harmony Viewer â€“ Max Controlled</title>

<script src="https://www.verovio.org/javascript/latest/verovio-toolkit.js"></script>

<style>
  body {
    font-family: system-ui, sans-serif;
    margin: 20px;
  }

  .controls {
    margin-bottom: 1em;
  }

  #viewer {
    position: relative;
    display: inline-block;
  }

  #score svg {
    width: 100%;
  }

  /* Highlight active notes */
  .active {
    fill: red !important;
    stroke: red !important;
  }

  /* ===== Analysis overlay ===== */
  #analysis-overlay {
    position: absolute;
    pointer-events: none;
    text-align: center;
    transform: translateX(-50%);
    white-space: nowrap;
  }

  .analysis-stufe {
    font-family: "Times New Roman", "Palatino Linotype", serif;
    font-size: 28px;
    font-weight: bold;
    line-height: 1.1;
  }

  .analysis-function {
    font-family: system-ui, sans-serif;
    font-size: 16px;
    letter-spacing: 0.05em;
    line-height: 1.1;
  }
</style>
</head>

<body>

<h2>Harmony Viewer (Max Controlled)</h2>

<div class="controls">
  <button onclick="advanceStep()">Next (debug)</button>
</div>

<div id="viewer">
  <div id="score"></div>

  <div id="analysis-overlay" style="display:none">
    <div class="analysis-stufe"></div>
    <div class="analysis-function"></div>
  </div>
</div>

<script>
/* =====================================================
   CONFIG
===================================================== */
const CC_STEP_SELECT = 22;   // CC number used by Max
const MIDI_CHANNEL  = 0;    // 0 = channel 1
const CC_STEP_COUNT = 23; // browser â†’ Max: number of steps

/* =====================================================
   GLOBAL STATE
===================================================== */
const vrvToolkit = new verovio.toolkit();

let steps = [];
let currentStep = 0;
let analysisData = null;

let globalBaselineY = null;

// MIDI
let midiOut = null;
let lastPlayedNotes = [];

/* =====================================================
   URL PARAMETERS
===================================================== */
const params = new URLSearchParams(window.location.search);
const scorePath = params.get("score") || "demo2.musicxml";
const analysisPath =
  params.get("analysis") || scorePath.replace(/\.musicxml$/i, ".json");

/* =====================================================
   LOAD SCORE
===================================================== */
fetch(scorePath)
  .then(r => r.text())
  .then(xml => {
    vrvToolkit.setOptions({
      scale: 40,
      pageHeight: 1000,
      pageWidth: 2000,
      footer: "none",

      // ðŸ”´ REQUIRED for MIDI pitch extraction
      svgAdditionalAttributes: true
    });


    document.getElementById("score").innerHTML =
      vrvToolkit.renderData(xml, {});

    buildSteps();
    renderStep();
  });

/* =====================================================
   LOAD ANALYSIS (OPTIONAL)
===================================================== */
fetch(analysisPath)
  .then(r => r.json())
  .then(json => {
    analysisData = json;
    renderStep();
  })
  .catch(() => console.log("No analysis JSON (ok)"));

/* =====================================================
   BUILD MUSICAL STEPS
===================================================== */
function buildSteps() {
  steps = [];

  document.querySelectorAll(".layer").forEach(layer => {
    Array.from(layer.children).forEach(el => {

      if (el.classList.contains("chord")) {
        const nh = el.querySelectorAll(".notehead");
        if (nh.length) steps.push([...nh]);
      }

      else if (el.classList.contains("note")) {
        const nh = el.querySelector(".notehead");
        if (nh) steps.push([nh]);
      }

      else if (el.classList.contains("beam")) {
        el.querySelectorAll(".note").forEach(n => {
          const nh = n.querySelector(".notehead");
          if (nh) steps.push([nh]);
        });
      }
    });
  });

  console.log("Total steps:", steps.length);
}

/* =====================================================
   RENDER CURRENT STEP
===================================================== */
function renderStep() {
  document.querySelectorAll(".notehead")
    .forEach(n => n.classList.remove("active"));

  const notes = steps[currentStep];
  if (!notes) return;

  notes.forEach(n => n.classList.add("active"));

  renderAnalysisHTML(notes);
  playCurrentStep();
}

/* =====================================================
   HTML ANALYSIS OVERLAY
===================================================== */
function renderAnalysisHTML(notes) {
  const overlay = document.getElementById("analysis-overlay");
  const viewer  = document.getElementById("viewer");

  if (!analysisData || !analysisData.steps) {
    overlay.style.display = "none";
    return;
  }

  const step = analysisData.steps[currentStep];
  if (!step || !step.stufe) {
    overlay.style.display = "none";
    return;
  }

  let minX = Infinity;
  let maxX = -Infinity;
  let maxY = -Infinity;

  notes.forEach(n => {
    const r = n.getBoundingClientRect();
    minX = Math.min(minX, r.left);
    maxX = Math.max(maxX, r.right);
    maxY = Math.max(maxY, r.bottom);
  });

  const centerX_screen = (minX + maxX) / 2;
  const viewerRect = viewer.getBoundingClientRect();
  const centerX = centerX_screen - viewerRect.left;

  if (globalBaselineY === null) {
    globalBaselineY = maxY - viewerRect.top + 10;
  }

  overlay.style.left = `${centerX}px`;
  overlay.style.top  = `${globalBaselineY}px`;
  overlay.style.display = "block";

  overlay.querySelector(".analysis-stufe").textContent = step.stufe;
  overlay.querySelector(".analysis-function").textContent =
    step.function || "";
}

/* =====================================================
   MIDI PITCH EXTRACTION
===================================================== */
function getMidiPitch(notehead) {
  const note = notehead.closest(".note");
  if (!note) return null;

  const xmlId = note.getAttribute("id");
  if (!xmlId) return null;

  const attrs = vrvToolkit.getElementAttr(xmlId);
  if (!attrs) return null;

  const pname = attrs.pname;
  const oct   = parseInt(attrs.oct, 10);
  const alter = parseInt(attrs.accid || "0", 10);

  if (!pname || isNaN(oct)) return null;

  const pc = { c:0, d:2, e:4, f:5, g:7, a:9, b:11 }[pname];
  if (pc === undefined) return null;

  // MIDI note number (C4 = 60)
  return pc + alter + (oct + 1) * 12;
}



/* =====================================================
   MIDI PLAYBACK
===================================================== */
function sendNoteOn(pitch, vel = 90) {
  if (!midiOut) {
    console.warn("NOTE ON skipped (no midiOut)", pitch);
    return;
  }

  console.log(
    "%cNOTE ON",
    "color: green; font-weight: bold;",
    "pitch =", pitch,
    "channel =", MIDI_CHANNEL + 1,
    "via =", midiOut.name
  );

  midiOut.send([0x90 | MIDI_CHANNEL, pitch, vel]);
}


function sendNoteOff(pitch) {
  if (!midiOut) return;

  console.log(
    "%cNOTE OFF",
    "color: gray;",
    "pitch =", pitch,
    "via =", midiOut.name
  );

  midiOut.send([0x80 | MIDI_CHANNEL, pitch, 0]);
}

function stopLastNotes() {
  lastPlayedNotes.forEach(p => sendNoteOff(p));
  lastPlayedNotes = [];
}

function playCurrentStep() {
  stopLastNotes();

  const notes = steps[currentStep];
  if (!notes) return;

  console.group("PLAY STEP", currentStep);

  notes.forEach(nh => {
    const pitch = getMidiPitch(nh);
    console.log("notehead â†’ MIDI pitch:", pitch);
    if (pitch !== null) {
      sendNoteOn(pitch);
      lastPlayedNotes.push(pitch);
    }
  });

  console.groupEnd();
}


/* =====================================================
   ADVANCE (DEBUG BUTTON)
===================================================== */
function advanceStep() {
  if (currentStep < steps.length - 1) {
    currentStep++;
    renderStep();
  }
}

/* =====================================================
   MIDI INPUT / OUTPUT
===================================================== */
if (navigator.requestMIDIAccess) {
  navigator.requestMIDIAccess().then(midi => {

    // -------- MIDI INPUT (Max â†’ Browser) --------
    for (let input of midi.inputs.values()) {
      console.log("MIDI IN:", input.name);

      if (input.name.includes("Maxâ†’Browser")) {
        console.log("BOUND INPUT:", input.name);

        input.onmidimessage = msg => {
          const [status, data1, data2] = msg.data;
          const type = status & 0xF0;
          const chan = status & 0x0F;

          // CC on channel 1
          if (type === 0xB0 && chan === 0 && data1 === 22) {
            const idx = data2 - 1;
            if (idx >= 0 && idx < steps.length) {
              currentStep = idx;
              renderStep();
            }
          }
        };
      }
    }

    // -------- MIDI OUTPUT (Browser â†’ Max) --------
    for (let output of midi.outputs.values()) {
      console.log("MIDI OUT:", output.name);

      if (output.name.includes("Browserâ†’Max")) {
        midiOut = output;
        console.log("BOUND OUTPUT:", output.name);
      }
    }

    if (!midiOut) {
      console.error("âŒ No Browserâ†’Max MIDI OUT bound");
    }
  });
}


</script>

</body>
</html>
