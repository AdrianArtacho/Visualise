<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Harmony Viewer â€“ Debugged Analysis Overlay</title>

<script src="https://www.verovio.org/javascript/latest/verovio-toolkit.js"></script>

<style>
  body {
    font-family: system-ui, sans-serif;
    margin: 20px;
  }

  #score svg {
    width: 100%;
    overflow: visible !important; /* ðŸ”‘ CRITICAL */
  }

  .controls {
    margin-bottom: 1em;
  }

  .active {
    filter: brightness(0.85);
  }

  /* Analysis text styles */
  .analysis-stufe {
    font-family: "Times New Roman", serif;
    font-size: 32px;
    font-weight: bold;
    fill: red; /* ðŸ”´ VERY VISIBLE */
  }

  .analysis-function {
    font-family: system-ui, sans-serif;
    font-size: 20px;
    fill: blue; /* ðŸ”µ VERY VISIBLE */
  }
</style>
</head>

<body>

<h2>Harmony Viewer (Debug Overlay)</h2>

<div class="controls">
  <button onclick="advanceStep()">Next</button>
  <span id="status"></span>
</div>

<div id="score"></div>

<script>
/* ==============================
   URL PARAMETERS
============================== */
function getURLParam(name) {
  return new URLSearchParams(window.location.search).get(name);
}

function deriveAnalysisPath(scorePath) {
  return scorePath.replace(/\.musicxml$/i, ".json");
}

const scorePath = getURLParam("score") || "demo2.musicxml";
const analysisPath =
  getURLParam("analysis") || deriveAnalysisPath(scorePath);

document.getElementById("status").textContent =
  `Score: ${scorePath}`;

/* ==============================
   GLOBAL STATE
============================== */
const vrvToolkit = new verovio.toolkit();
let chordGroups = [];
let currentStep = 0;
let analysisData = null;

/* ==============================
   LOAD SCORE
============================== */
fetch(scorePath)
  .then(r => r.text())
  .then(xml => {
    vrvToolkit.setOptions({
      scale: 40,
      pageHeight: 1000,
      pageWidth: 2000
    });

    document.getElementById("score").innerHTML =
      vrvToolkit.renderData(xml, {});

    buildChordGroups();
    highlightCurrentStep();
  });

/* ==============================
   LOAD ANALYSIS
============================== */
fetch(analysisPath)
  .then(r => r.json())
  .then(json => {
    analysisData = json;
    console.log("Analysis loaded:", analysisData);
    highlightCurrentStep();
  })
  .catch(() => console.log("No analysis JSON found"));

/* ==============================
   BUILD STEPS
============================== */
function buildChordGroups() {
  chordGroups = [];

  document.querySelectorAll(".layer").forEach(layer => {
    Array.from(layer.children).forEach(el => {

      if (el.classList.contains("chord")) {
        const nh = el.querySelectorAll(".notehead");
        if (nh.length) chordGroups.push([...nh]);
      }

      else if (el.classList.contains("note")) {
        const nh = el.querySelector(".notehead");
        if (nh) chordGroups.push([nh]);
      }

      else if (el.classList.contains("beam")) {
        el.querySelectorAll(".note").forEach(n => {
          const nh = n.querySelector(".notehead");
          if (nh) chordGroups.push([nh]);
        });
      }
    });
  });

  console.log("Steps:", chordGroups.length);
}

/* ==============================
   HIGHLIGHT + ANALYSIS
============================== */
function highlightCurrentStep() {
  document.querySelectorAll(".notehead").forEach(n => {
    n.classList.remove("active");
    n.style.fill = "";
  });

  clearOverlay();

  const notes = chordGroups[currentStep];
  if (!notes) return;

  notes.forEach(n => n.classList.add("active"));

  applyAnalysis();
}

function clearOverlay() {
  const old = document.getElementById("analysis-overlay");
  if (old) old.remove();
}

function applyAnalysis() {
  if (!analysisData || !analysisData.steps) return;

  const step = analysisData.steps[currentStep];
  if (!step || !step.stufe) return;

  placeOverlay(step);
}

function placeOverlay(step) {
  const svg = document.querySelector("#score svg");
  if (!svg) return;

  const notes = chordGroups[currentStep];
  if (!notes.length) return;

  let minX = Infinity;
  let minY = Infinity;

  notes.forEach(n => {
    const b = n.getBBox();
    minX = Math.min(minX, b.x);
    minY = Math.min(minY, b.y);
  });

  const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
  g.setAttribute("id", "analysis-overlay");
  g.setAttribute("pointer-events", "none");

  /* ðŸ”´ PLACE ABOVE NOTES (GUARANTEED VISIBLE) */
  const stufe = document.createElementNS("http://www.w3.org/2000/svg", "text");
  stufe.setAttribute("x", minX);
  stufe.setAttribute("y", minY - 40);
  stufe.setAttribute("class", "analysis-stufe");
  stufe.textContent = step.stufe;

  g.appendChild(stufe);

  if (step.function) {
    const func = document.createElementNS("http://www.w3.org/2000/svg", "text");
    func.setAttribute("x", minX);
    func.setAttribute("y", minY - 15);
    func.setAttribute("class", "analysis-function");
    func.textContent = step.function;
    g.appendChild(func);
  }

  svg.appendChild(g);
}

/* ==============================
   STEP ADVANCE
============================== */
function advanceStep() {
  if (currentStep < chordGroups.length - 1) {
    currentStep++;
    highlightCurrentStep();
  }
}

/* ==============================
   MIDI
============================== */
if (navigator.requestMIDIAccess) {
  navigator.requestMIDIAccess().then(midi => {
    for (let input of midi.inputs.values()) {
      input.onmidimessage = msg => {
        const [status, , vel] = msg.data;
        if (status === 144 && vel > 0) advanceStep();
      };
    }
  });
}
</script>

</body>
</html>
